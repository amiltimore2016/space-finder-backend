"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GenericTable = void 0;
const aws_dynamodb_1 = require("aws-cdk-lib/aws-dynamodb");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_lambda_nodejs_1 = require("aws-cdk-lib/aws-lambda-nodejs");
const aws_apigateway_1 = require("aws-cdk-lib/aws-apigateway");
const path_1 = require("path");
class GenericTable {
    constructor(stack, props) {
        this.props = props;
        this.stack = stack;
        this.initialize();
    }
    initialize() {
        this.createTable();
        this.addSecondaryIndexes();
        this.createLambdas();
        this.grantTableRights();
    }
    createTable() {
        this.table = new aws_dynamodb_1.Table(this.stack, this.props.tableName, {
            partitionKey: {
                name: this.props.primaryKey,
                type: aws_dynamodb_1.AttributeType.STRING
            },
            tableName: this.props.tableName,
            removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY
        });
    }
    addSecondaryIndexes() {
        if (this.props.secondaryIndexes) {
            for (const secondaryIndex of this.props.secondaryIndexes) {
                this.table.addGlobalSecondaryIndex({
                    indexName: secondaryIndex,
                    partitionKey: {
                        name: secondaryIndex,
                        type: aws_dynamodb_1.AttributeType.STRING
                    }
                });
            }
        }
    }
    createLambdas() {
        if (this.props.createLambdaPath) {
            this.createLambda = this.createSingleLambda(this.props.createLambdaPath);
            this.createLambdaIntegration = new aws_apigateway_1.LambdaIntegration(this.createLambda);
        }
        if (this.props.readLambdaPath) {
            this.readLambda = this.createSingleLambda(this.props.readLambdaPath);
            this.readLambdaIntegration = new aws_apigateway_1.LambdaIntegration(this.readLambda);
        }
        if (this.props.updateLambdaPath) {
            this.updateLambda = this.createSingleLambda(this.props.updateLambdaPath);
            this.updateLambdaIntegration = new aws_apigateway_1.LambdaIntegration(this.updateLambda);
        }
        if (this.props.deleteLambdaPath) {
            this.deleteLambda = this.createSingleLambda(this.props.deleteLambdaPath);
            this.deleteLambdaIntegration = new aws_apigateway_1.LambdaIntegration(this.deleteLambda);
        }
    }
    grantTableRights() {
        if (this.createLambda) {
            this.table.grantWriteData(this.createLambda);
        }
        if (this.readLambda) {
            this.table.grantReadData(this.readLambda);
        }
        if (this.updateLambda) {
            this.table.grantWriteData(this.updateLambda);
        }
        if (this.deleteLambda) {
            this.table.grantWriteData(this.deleteLambda);
        }
    }
    createSingleLambda(lambdaName) {
        const lambdaId = `${this.props.tableName}-${lambdaName}`;
        return new aws_lambda_nodejs_1.NodejsFunction(this.stack, lambdaId, {
            entry: ((0, path_1.join)(__dirname, '..', 'services', this.props.tableName, `${lambdaName}.ts`)),
            handler: 'handler',
            functionName: lambdaId,
            environment: {
                TABLE_NAME: this.props.tableName,
                PRIMARY_KEY: this.props.primaryKey
            }
        });
    }
}
exports.GenericTable = GenericTable;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR2VuZXJpdGNUYWJsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkdlbmVyaXRjVGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkRBQWdFO0FBQ2hFLDZDQUFrRDtBQUNsRCxxRUFBK0Q7QUFDL0QsK0RBQStEO0FBQy9ELCtCQUE0QjtBQVk1QixNQUFhLFlBQVk7SUFnQnJCLFlBQW1CLEtBQVksRUFBRSxLQUFpQjtRQUM5QyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVPLFVBQVU7UUFDZCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFTyxXQUFXO1FBQ2YsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLG9CQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUNyRCxZQUFZLEVBQUU7Z0JBQ1YsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVTtnQkFDM0IsSUFBSSxFQUFFLDRCQUFhLENBQUMsTUFBTTthQUM3QjtZQUNELFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVM7WUFDL0IsYUFBYSxFQUFFLDJCQUFhLENBQUMsT0FBTztTQUN2QyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sbUJBQW1CO1FBQ3ZCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsRUFBRTtZQUM3QixLQUFJLE1BQU0sY0FBYyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQ3JELElB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QUFDLEtBQUssQ0FBQyxVQUFVO2FBQ3JDO1NBQ0osQ0FBRSxDQUFBO0lBQ1AsQ0FBQztDQUNKO0FBcEdELG9DQW9HQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEF0dHJpYnV0ZVR5cGUsIFRhYmxlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWR5bmFtb2RiJztcbmltcG9ydCB7IFJlbW92YWxQb2xpY3ksIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInXG5pbXBvcnQgeyBOb2RlanNGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IExhbWJkYUludGVncmF0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwaWdhdGV3YXknO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRhYmxlUHJvcHMge1xuICAgIHRhYmxlTmFtZTogc3RyaW5nLFxuICAgIHByaW1hcnlLZXk6IHN0cmluZyxcbiAgICBjcmVhdGVMYW1iZGFQYXRoPzogc3RyaW5nLFxuICAgIHJlYWRMYW1iZGFQYXRoPzogc3RyaW5nLFxuICAgIHVwZGF0ZUxhbWJkYVBhdGg/OiBzdHJpbmcsXG4gICAgZGVsZXRlTGFtYmRhUGF0aD86IHN0cmluZyxcbiAgICBzZWNvbmRhcnlJbmRleGVzPzogc3RyaW5nW11cbn1cblxuZXhwb3J0IGNsYXNzIEdlbmVyaWNUYWJsZSB7XG5cbiAgICBwcml2YXRlIHN0YWNrOiBTdGFjaztcbiAgICBwcml2YXRlIHRhYmxlOiBUYWJsZTtcbiAgICBwcml2YXRlIHByb3BzOiBUYWJsZVByb3BzO1xuXG4gICAgcHJpdmF0ZSBjcmVhdGVMYW1iZGE6IE5vZGVqc0Z1bmN0aW9uIHwgdW5kZWZpbmVkO1xuICAgIHByaXZhdGUgcmVhZExhbWJkYTogTm9kZWpzRnVuY3Rpb24gfCB1bmRlZmluZWQ7XG4gICAgcHJpdmF0ZSB1cGRhdGVMYW1iZGE6IE5vZGVqc0Z1bmN0aW9uIHwgdW5kZWZpbmVkO1xuICAgIHByaXZhdGUgZGVsZXRlTGFtYmRhOiBOb2RlanNGdW5jdGlvbiB8IHVuZGVmaW5lZDtcblxuICAgIHB1YmxpYyBjcmVhdGVMYW1iZGFJbnRlZ3JhdGlvbjogTGFtYmRhSW50ZWdyYXRpb247XG4gICAgcHVibGljIHJlYWRMYW1iZGFJbnRlZ3JhdGlvbjogTGFtYmRhSW50ZWdyYXRpb247XG4gICAgcHVibGljIHVwZGF0ZUxhbWJkYUludGVncmF0aW9uOiBMYW1iZGFJbnRlZ3JhdGlvbjtcbiAgICBwdWJsaWMgZGVsZXRlTGFtYmRhSW50ZWdyYXRpb246IExhbWJkYUludGVncmF0aW9uO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKHN0YWNrOiBTdGFjaywgcHJvcHM6IFRhYmxlUHJvcHMpIHtcbiAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzO1xuICAgICAgICB0aGlzLnN0YWNrID0gc3RhY2s7XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaW5pdGlhbGl6ZSgpe1xuICAgICAgICB0aGlzLmNyZWF0ZVRhYmxlKCk7XG4gICAgICAgIHRoaXMuYWRkU2Vjb25kYXJ5SW5kZXhlcygpO1xuICAgICAgICB0aGlzLmNyZWF0ZUxhbWJkYXMoKTtcbiAgICAgICAgdGhpcy5ncmFudFRhYmxlUmlnaHRzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVUYWJsZSgpe1xuICAgICAgICB0aGlzLnRhYmxlID0gbmV3IFRhYmxlKHRoaXMuc3RhY2ssIHRoaXMucHJvcHMudGFibGVOYW1lLCB7XG4gICAgICAgICAgICBwYXJ0aXRpb25LZXk6IHtcbiAgICAgICAgICAgICAgICBuYW1lOiB0aGlzLnByb3BzLnByaW1hcnlLZXksXG4gICAgICAgICAgICAgICAgdHlwZTogQXR0cmlidXRlVHlwZS5TVFJJTkdcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0YWJsZU5hbWU6IHRoaXMucHJvcHMudGFibGVOYW1lLFxuICAgICAgICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYWRkU2Vjb25kYXJ5SW5kZXhlcygpIHtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuc2Vjb25kYXJ5SW5kZXhlcykge1xuICAgICAgICAgICAgZm9yKGNvbnN0IHNlY29uZGFyeUluZGV4IG9mIHRoaXMucHJvcHMuc2Vjb25kYXJ5SW5kZXhlcykge1xuICAgICAgICAgICAgICAgIHRoaXMudGFibGUuYWRkR2xvYmFsU2Vjb25kYXJ5SW5kZXgoe1xuICAgICAgICAgICAgICAgIGluZGV4TmFtZTogc2Vjb25kYXJ5SW5kZXgsXG4gICAgICAgICAgICAgICAgICBwYXJ0aXRpb25LZXk6IHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogc2Vjb25kYXJ5SW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IEF0dHJpYnV0ZVR5cGUuU1RSSU5HXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUxhbWJkYXMoKSB7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLmNyZWF0ZUxhbWJkYVBhdGgpe1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVMYW1iZGEgPSB0aGlzLmNyZWF0ZVNpbmdsZUxhbWJkYSh0aGlzLnByb3BzLmNyZWF0ZUxhbWJkYVBhdGgpXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUxhbWJkYUludGVncmF0aW9uID0gbmV3IExhbWJkYUludGVncmF0aW9uKHRoaXMuY3JlYXRlTGFtYmRhKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5wcm9wcy5yZWFkTGFtYmRhUGF0aCkge1xuICAgICAgICAgICAgdGhpcy5yZWFkTGFtYmRhID0gdGhpcy5jcmVhdGVTaW5nbGVMYW1iZGEodGhpcy5wcm9wcy5yZWFkTGFtYmRhUGF0aClcbiAgICAgICAgICAgIHRoaXMucmVhZExhbWJkYUludGVncmF0aW9uID0gbmV3IExhbWJkYUludGVncmF0aW9uKHRoaXMucmVhZExhbWJkYSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucHJvcHMudXBkYXRlTGFtYmRhUGF0aCkge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVMYW1iZGEgPSB0aGlzLmNyZWF0ZVNpbmdsZUxhbWJkYSh0aGlzLnByb3BzLnVwZGF0ZUxhbWJkYVBhdGgpXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUxhbWJkYUludGVncmF0aW9uID0gbmV3IExhbWJkYUludGVncmF0aW9uKHRoaXMudXBkYXRlTGFtYmRhKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5wcm9wcy5kZWxldGVMYW1iZGFQYXRoKSB7XG4gICAgICAgICAgICB0aGlzLmRlbGV0ZUxhbWJkYSA9IHRoaXMuY3JlYXRlU2luZ2xlTGFtYmRhKHRoaXMucHJvcHMuZGVsZXRlTGFtYmRhUGF0aClcbiAgICAgICAgICAgIHRoaXMuZGVsZXRlTGFtYmRhSW50ZWdyYXRpb24gPSBuZXcgTGFtYmRhSW50ZWdyYXRpb24odGhpcy5kZWxldGVMYW1iZGEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBncmFudFRhYmxlUmlnaHRzKCl7XG4gICAgICAgIGlmKHRoaXMuY3JlYXRlTGFtYmRhKXtcbiAgICAgICAgICAgIHRoaXMudGFibGUuZ3JhbnRXcml0ZURhdGEodGhpcy5jcmVhdGVMYW1iZGEpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucmVhZExhbWJkYSl7XG4gICAgICAgICAgICB0aGlzLnRhYmxlLmdyYW50UmVhZERhdGEodGhpcy5yZWFkTGFtYmRhKVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZUxhbWJkYSl7XG4gICAgICAgICAgICB0aGlzLnRhYmxlLmdyYW50V3JpdGVEYXRhKHRoaXMudXBkYXRlTGFtYmRhKVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmRlbGV0ZUxhbWJkYSl7XG4gICAgICAgICAgICB0aGlzLnRhYmxlLmdyYW50V3JpdGVEYXRhKHRoaXMuZGVsZXRlTGFtYmRhKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVTaW5nbGVMYW1iZGEobGFtYmRhTmFtZTogc3RyaW5nKTogTm9kZWpzRnVuY3Rpb257XG4gICAgICAgIGNvbnN0IGxhbWJkYUlkID0gYCR7dGhpcy5wcm9wcy50YWJsZU5hbWV9LSR7bGFtYmRhTmFtZX1gOyBcbiAgICAgICAgcmV0dXJuIG5ldyBOb2RlanNGdW5jdGlvbih0aGlzLnN0YWNrLCBsYW1iZGFJZCwge1xuICAgICAgICAgICAgZW50cnk6IChqb2luKF9fZGlybmFtZSwgJy4uJywgJ3NlcnZpY2VzJywgdGhpcy5wcm9wcy50YWJsZU5hbWUsIGAke2xhbWJkYU5hbWV9LnRzYCkpLFxuICAgICAgICAgICAgaGFuZGxlcjogJ2hhbmRsZXInLFxuICAgICAgICAgICAgZnVuY3Rpb25OYW1lOiBsYW1iZGFJZCxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgVEFCTEVfTkFNRTogdGhpcy5wcm9wcy50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgUFJJTUFSWV9LRVk6IHRoaXMucHJvcHMucHJpbWFyeUtleVxuICAgICAgICAgICAgfVxuICAgICAgICB9IClcbiAgICB9XG59Il19