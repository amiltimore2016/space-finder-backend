"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpaceStack = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_lambda_1 = require("aws-cdk-lib/aws-lambda");
const path_1 = require("path");
const aws_apigateway_1 = require("aws-cdk-lib/aws-apigateway");
const GeneritcTable_1 = require("./GeneritcTable");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const AuthorizeWrapper_1 = require("./auth/AuthorizeWrapper");
class SpaceStack extends aws_cdk_lib_1.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        this.api = new aws_apigateway_1.RestApi(this, "spaceApi");
        this.SpacesTable = new GeneritcTable_1.GenericTable(this, {
            tableName: "SpacesTable",
            primaryKey: "spaceId",
            createLambdaPath: "Create",
            readLambdaPath: "Read",
            updateLambdaPath: "Update",
            deleteLambdaPath: "Delete",
            secondaryIndexes: ["location"],
        });
        this.authorizer = new AuthorizeWrapper_1.AuthorizeWrapper(this, this.api);
        const nodeLambdaNodeJs = new aws_cdk_lib_1.aws_lambda_nodejs.NodejsFunction(this, "helloLambdaNodejs", {
            entry: (0, path_1.join)(__dirname, "..", "services", "node-lambda", "hello.ts"),
            handler: "handler",
            runtime: aws_lambda_1.Runtime.NODEJS_18_X,
        });
        const s3ListPolicy = new aws_iam_1.PolicyStatement();
        s3ListPolicy.addActions("s3:ListAllMyBuckets");
        s3ListPolicy.addResources("*");
        nodeLambdaNodeJs.addToRolePolicy(s3ListPolicy);
        const optionsWithAuthorizer = {
            authorizationType: aws_apigateway_1.AuthorizationType.COGNITO,
            authorizer: {
                authorizerId: this.authorizer.authorizer.authorizerId
            }
        };
        // Hello Api Lambda integration:
        const HelloLambdaIntegration = new aws_apigateway_1.LambdaIntegration(nodeLambdaNodeJs);
        const HelloLambdaResource = this.api.root.addResource("hello");
        HelloLambdaResource.addMethod("GET", HelloLambdaIntegration, optionsWithAuthorizer);
        // Spaces API Integration
        const spaceResource = this.api.root.addResource("spaces");
        spaceResource.addMethod("POST", this.SpacesTable.createLambdaIntegration);
        spaceResource.addMethod("GET", this.SpacesTable.readLambdaIntegration);
        spaceResource.addMethod("PUT", this.SpacesTable.updateLambdaIntegration);
        spaceResource.addMethod("DELETE", this.SpacesTable.deleteLambdaIntegration);
    }
}
exports.SpaceStack = SpaceStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3BhY2VTdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlNwYWNlU3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkNBQW1FO0FBRW5FLHVEQUFpRDtBQUNqRCwrQkFBNEI7QUFDNUIsK0RBQTBHO0FBQzFHLG1EQUErQztBQUMvQyxpREFBc0Q7QUFDdEQsOERBQTJEO0FBRTNELE1BQWEsVUFBVyxTQUFRLG1CQUFLO0lBY25DLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBaUI7UUFDekQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFkbEIsUUFBRyxHQUFHLElBQUksd0JBQU8sQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFHcEMsZ0JBQVcsR0FBRyxJQUFJLDRCQUFZLENBQUMsSUFBSSxFQUFFO1lBQzNDLFNBQVMsRUFBRSxhQUFhO1lBQ3hCLFVBQVUsRUFBRSxTQUFTO1lBQ3JCLGdCQUFnQixFQUFFLFFBQVE7WUFDMUIsY0FBYyxFQUFFLE1BQU07WUFDdEIsZ0JBQWdCLEVBQUUsUUFBUTtZQUMxQixnQkFBZ0IsRUFBRSxRQUFRO1lBQzFCLGdCQUFnQixFQUFFLENBQUMsVUFBVSxDQUFDO1NBQy9CLENBQUMsQ0FBQztRQUtELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxtQ0FBZ0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBRXRELE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSwrQkFBaUIsQ0FBQyxjQUFjLENBQzNELElBQUksRUFDSixtQkFBbUIsRUFDbkI7WUFDRSxLQUFLLEVBQUUsSUFBQSxXQUFJLEVBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLFVBQVUsQ0FBQztZQUNuRSxPQUFPLEVBQUUsU0FBUztZQUNsQixPQUFPLEVBQUUsb0JBQU8sQ0FBQyxXQUFXO1NBQzdCLENBQ0YsQ0FBQztRQUVGLE1BQU0sWUFBWSxHQUFHLElBQUkseUJBQWUsRUFBRSxDQUFDO1FBQzNDLFlBQVksQ0FBQyxVQUFVLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUMvQyxZQUFZLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9CLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUUvQyxNQUFNLHFCQUFxQixHQUFrQjtZQUMzQyxpQkFBaUIsRUFBRSxrQ0FBaUIsQ0FBQyxPQUFPO1lBQzVDLFVBQVUsRUFBRTtnQkFDVixZQUFZLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsWUFBWTthQUN0RDtTQUNGLENBQUE7UUFFRCxnQ0FBZ0M7UUFDaEMsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLGtDQUFpQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDdkUsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDL0QsbUJBQW1CLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxzQkFBc0IsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO1FBRXBGLHlCQUF5QjtRQUN6QixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUQsYUFBYSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQzFFLGFBQWEsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUN2RSxhQUFhLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDekUsYUFBYSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0lBQzlFLENBQUM7Q0FDRjtBQXJERCxnQ0FxREMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdGFjaywgU3RhY2tQcm9wcywgYXdzX2xhbWJkYV9ub2RlanMgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IFJ1bnRpbWUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IEF1dGhvcml6YXRpb25UeXBlLCBMYW1iZGFJbnRlZ3JhdGlvbiwgTWV0aG9kT3B0aW9ucywgUmVzdEFwaSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5JztcbmltcG9ydCB7IEdlbmVyaWNUYWJsZSB9IGZyb20gJy4vR2VuZXJpdGNUYWJsZSc7XG5pbXBvcnQgeyBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IEF1dGhvcml6ZVdyYXBwZXIgfSBmcm9tICcuL2F1dGgvQXV0aG9yaXplV3JhcHBlcic7XG5cbmV4cG9ydCBjbGFzcyBTcGFjZVN0YWNrIGV4dGVuZHMgU3RhY2sge1xuICBwcml2YXRlIGFwaSA9IG5ldyBSZXN0QXBpKHRoaXMsIFwic3BhY2VBcGlcIik7XG4gIHByaXZhdGUgYXV0aG9yaXplcjogQXV0aG9yaXplV3JhcHBlcjtcblxuICBwcml2YXRlIFNwYWNlc1RhYmxlID0gbmV3IEdlbmVyaWNUYWJsZSh0aGlzLCB7XG4gICAgdGFibGVOYW1lOiBcIlNwYWNlc1RhYmxlXCIsXG4gICAgcHJpbWFyeUtleTogXCJzcGFjZUlkXCIsXG4gICAgY3JlYXRlTGFtYmRhUGF0aDogXCJDcmVhdGVcIixcbiAgICByZWFkTGFtYmRhUGF0aDogXCJSZWFkXCIsXG4gICAgdXBkYXRlTGFtYmRhUGF0aDogXCJVcGRhdGVcIixcbiAgICBkZWxldGVMYW1iZGFQYXRoOiBcIkRlbGV0ZVwiLFxuICAgIHNlY29uZGFyeUluZGV4ZXM6IFtcImxvY2F0aW9uXCJdLFxuICB9KTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgdGhpcy5hdXRob3JpemVyID0gbmV3IEF1dGhvcml6ZVdyYXBwZXIodGhpcywgdGhpcy5hcGkpXG5cbiAgICBjb25zdCBub2RlTGFtYmRhTm9kZUpzID0gbmV3IGF3c19sYW1iZGFfbm9kZWpzLk5vZGVqc0Z1bmN0aW9uKFxuICAgICAgdGhpcyxcbiAgICAgIFwiaGVsbG9MYW1iZGFOb2RlanNcIixcbiAgICAgIHtcbiAgICAgICAgZW50cnk6IGpvaW4oX19kaXJuYW1lLCBcIi4uXCIsIFwic2VydmljZXNcIiwgXCJub2RlLWxhbWJkYVwiLCBcImhlbGxvLnRzXCIpLFxuICAgICAgICBoYW5kbGVyOiBcImhhbmRsZXJcIixcbiAgICAgICAgcnVudGltZTogUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgY29uc3QgczNMaXN0UG9saWN5ID0gbmV3IFBvbGljeVN0YXRlbWVudCgpO1xuICAgIHMzTGlzdFBvbGljeS5hZGRBY3Rpb25zKFwiczM6TGlzdEFsbE15QnVja2V0c1wiKTtcbiAgICBzM0xpc3RQb2xpY3kuYWRkUmVzb3VyY2VzKFwiKlwiKTtcbiAgICBub2RlTGFtYmRhTm9kZUpzLmFkZFRvUm9sZVBvbGljeShzM0xpc3RQb2xpY3kpO1xuXG4gICAgY29uc3Qgb3B0aW9uc1dpdGhBdXRob3JpemVyOiBNZXRob2RPcHRpb25zID0ge1xuICAgICAgYXV0aG9yaXphdGlvblR5cGU6IEF1dGhvcml6YXRpb25UeXBlLkNPR05JVE8sXG4gICAgICBhdXRob3JpemVyOiB7XG4gICAgICAgIGF1dGhvcml6ZXJJZDogdGhpcy5hdXRob3JpemVyLmF1dGhvcml6ZXIuYXV0aG9yaXplcklkXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gSGVsbG8gQXBpIExhbWJkYSBpbnRlZ3JhdGlvbjpcbiAgICBjb25zdCBIZWxsb0xhbWJkYUludGVncmF0aW9uID0gbmV3IExhbWJkYUludGVncmF0aW9uKG5vZGVMYW1iZGFOb2RlSnMpO1xuICAgIGNvbnN0IEhlbGxvTGFtYmRhUmVzb3VyY2UgPSB0aGlzLmFwaS5yb290LmFkZFJlc291cmNlKFwiaGVsbG9cIik7XG4gICAgSGVsbG9MYW1iZGFSZXNvdXJjZS5hZGRNZXRob2QoXCJHRVRcIiwgSGVsbG9MYW1iZGFJbnRlZ3JhdGlvbiwgb3B0aW9uc1dpdGhBdXRob3JpemVyKTtcblxuICAgIC8vIFNwYWNlcyBBUEkgSW50ZWdyYXRpb25cbiAgICBjb25zdCBzcGFjZVJlc291cmNlID0gdGhpcy5hcGkucm9vdC5hZGRSZXNvdXJjZShcInNwYWNlc1wiKTtcbiAgICBzcGFjZVJlc291cmNlLmFkZE1ldGhvZChcIlBPU1RcIiwgdGhpcy5TcGFjZXNUYWJsZS5jcmVhdGVMYW1iZGFJbnRlZ3JhdGlvbik7XG4gICAgc3BhY2VSZXNvdXJjZS5hZGRNZXRob2QoXCJHRVRcIiwgdGhpcy5TcGFjZXNUYWJsZS5yZWFkTGFtYmRhSW50ZWdyYXRpb24pO1xuICAgIHNwYWNlUmVzb3VyY2UuYWRkTWV0aG9kKFwiUFVUXCIsIHRoaXMuU3BhY2VzVGFibGUudXBkYXRlTGFtYmRhSW50ZWdyYXRpb24pO1xuICAgIHNwYWNlUmVzb3VyY2UuYWRkTWV0aG9kKFwiREVMRVRFXCIsIHRoaXMuU3BhY2VzVGFibGUuZGVsZXRlTGFtYmRhSW50ZWdyYXRpb24pO1xuICB9XG59Il19